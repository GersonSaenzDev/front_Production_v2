<!-- /app/barcode-printing/barcode-printing/barcode-printing.html -->
<div class="inventory-container" [ngClass]="{ 'loading': loading }">
  <header class="header">
    <h1>Impresión de Etiquetas a Producción</h1>
  </header>

  <div class="main-content">
    <div class="layout-row">
            <aside class="left-panel-col">
        <div class="panel-card">
          <div class="panel-header">
            <h2>Parámetros de Impresión</h2>
          </div>

          <div class="panel-body">
            <div class="form-group">
              <label for="productReference">Referencia en Producción (*)</label>
              <div class="position-relative">
                <input
                  id="productReference"
                  type="text"
                  class="form-control"
                  [(ngModel)]="selectedReference"
                  placeholder="Escriba código o nombre de referencia"
                  autocomplete="off"
                  (input)="onReferenceInput($event)"
                  (focus)="onFocus()"
                  (blur)="onBlur()"
                />
                <div class="spinner" *ngIf="loading" aria-hidden="true">
                  <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>

                <div class="autocomplete-results shadow-lg" *ngIf="predictiveList.length > 0 && showDropdown">
                  <div
                    class="autocomplete-item"
                    *ngFor="let item of predictiveList; let i = index"
                    (click)="selectReference(item)"
                  >
                    <div class="item-ref"><strong>{{ item.reference }}</strong></div>
                    <div class="item-name text-muted small">{{ item.productName }}</div>
                  </div>
                </div>
              </div>
            </div>

            <hr />

            <h3>Información de la Referencia</h3>

            <div class="form-group">
              <label for="productName">Nombre Producto</label>
              <input id="productName" type="text" class="form-control" [(ngModel)]="productName" readonly />
            </div>

            <div class="form-group">
              <label for="EAN">EAN</label>
              <input id="EAN" type="text" class="form-control" [(ngModel)]="EAN" readonly />
            </div>

            <div class="form-group">
              <label for="productCode">Código Producto</label>
              <input id="productCode" type="text" class="form-control" [(ngModel)]="productCode" readonly />
            </div>

            <div class="form-group">
              <label for="labelCode">Consecutivo Producto</label>
              <input id="labelCode" type="text" class="form-control" [(ngModel)]="labelCode" readonly />
            </div>

            <div class="form-group">
              <label for="quantity">Cantidad de Etiquetas a Imprimir <span class="text-danger">*</span></label>
              <input
                id="quantity"
                type="number"
                class="form-control"
                [(ngModel)]="quantity"
                placeholder="Ingrese cantidad de etiquetas"
                min="1"
              />
              <div class="invalid-feedback" *ngIf="quantityInvalid">
                La cantidad de etiquetas es obligatoria.
              </div>
            </div>

            <div class="button-group">
              <button type="button" class="btn btn-secondary" (click)="clearForm()">Limpiar</button>
              <button type="button" class="btn btn-primary" (click)="generateLabels()" [disabled]="!selectedReference || !quantity || quantity <= 0">Generar Impresión</button>
            </div>
            <button class="btn btn-info" [disabled]="!allCreated" (click)="validateLabels(validationModalContent)">Validar</button>
          </div>
        </div>
      </aside>
                  <main class="right-panel-col">
        <div class="panel-card">
          <div class="panel-header">
            <h2>Etiquetas Generadas <small class="muted">({{ generatedLabels.length }})</small></h2>
          </div>

          <div class="panel-body labels-panel">
            <div *ngIf="generatedLabels.length === 0" class="placeholder">
              Ingrese una referencia y cantidad para generar las etiquetas
            </div>

            <div *ngIf="generatedLabels.length > 0" class="labels-area">
              <div class="labels-actions">
                <div class="left-actions">
                  <button 
                    class="btn btn-primary" 
                    (click)="sendLabelsToPrinting()" 
                    [disabled]="printedFromDB"
                  >
                      {{ printedFromDB ? 'Reimprimir Etiquetas' : 'Marcar como Creados' }}
                    </button>
                    <!-- <button class="btn btn-info" [disabled]="!allCreated" (click)="validateLabels(validationModalContent)">Validar</button> -->
                  <ng-template #validationModalContent let-modal>
                  </ng-template>

                </div>
                <div class="right-actions">
                  <span class="status-info">Estado: 
                    <strong *ngIf="!printedFromDB" class="text-danger">Pendiente</strong>
                    <strong *ngIf="printedFromDB" class="text-success">Creado (Listo para Validar)</strong>
                  </span>
                </div>
              </div>

              <div class="labels-list-wrapper">
                <ul class="codes-list labels-list">
                  <li *ngFor="let label of generatedLabels; let i = index" [ngClass]="label.status">
                    <div class="code-number">{{ label.number }}</div>
                    <div class="code-meta">
                      <span class="badge" [ngClass]="{
                        'badge-created': label.status === 'created', 
                        'badge-validated': label.status === 'validated',
                        'badge-missing': label.status === 'missing',
                        'badge-error': label.status === 'error'
                      }">
                        {{ 
                          label.status === 'validated' ? 'Leído' : 
                          (label.status === 'created' ? 'Creado' : 
                          (label.status === 'missing' ? 'Faltante' : 
                          (label.status === 'error' ? 'Error' : 'Pendiente'))) 
                        }}
                      </span>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>

<ng-template #validationModalContent let-modal>
        <div class="modal-header">
        <h4 class="modal-title">Contador y Validación de Códigos</h4>
        <button type="button" class="btn-close" (click)="modal.dismiss('Cancel')"></button>
    </div>
    <div class="modal-body">
        
        <p>Etiquetas Generadas (EAN-128): <strong>{{ generatedLabels.length }}</strong></p>
        <hr>

                <h4>Escanear Códigos (EAN-128)</h4>
        <div class="input-group mb-4">
            <input 
                #scanInput
                type="text" 
                class="form-control form-control-lg" 
                placeholder="Escanee EAN-128 (Lectura Automática)"
                [(ngModel)]="ean128Input"
                (keyup)="onEAN128Scan($event)"                 (keyup.enter)="addEAN128()"             >
        </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Códigos Leídos: <strong [class.text-success]="validatedEAN128.length === generatedLabels.length">{{ validatedEAN128.length }}</strong></h5>
            <span class="badge bg-info text-dark">
              Faltan: {{ generatedLabels.length - validatedEAN128.length > 0 ? generatedLabels.length - validatedEAN128.length : 0 }}
            </span>
        </div>
        
        <div class="list-group codes-read-list" style="max-height: 250px; overflow-y: auto;">
            <div class="list-group-item d-flex justify-content-between align-items-center"
                *ngFor="let entry of validatedEAN128; let i = index">
                <span class="text-truncate code-text">{{ entry.code }}</span>
                <button class="btn btn-sm btn-outline-danger ms-3" (click)="removeEAN128(i)">
                  [Borrar]
                </button>
            </div>
            <div *ngIf="validatedEAN128.length === 0" class="list-group-item text-center text-muted">
              Escanee códigos para empezar.
            </div>
        </div>

        <hr>

        <div class="d-grid gap-2 mb-3">
                        <button 
              class="btn btn-success btn-lg" 
              [disabled]="validatedEAN128.length < generatedLabels.length"
              (click)="processFinalValidation(modal)"
            >
                Procesar Validación Final
            </button>
        </div>
                <div class="d-grid">
            <button class="btn btn-danger" type="button" (click)="clearModalInputs()">
              Limpiar Lecturas
            </button>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('Cerrar')">Cerrar</button>
    </div>
</ng-template>



