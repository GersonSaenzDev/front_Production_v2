<!-- src/app/barcode-printing/read-barcode/read-barcode.html -->
<div class="inventory-container">
  <header class="header">
    <h1>Gestión de Etiquetas</h1>
  </header>

  <div class="main-content">
    <div class="left-panel">
      <h4>Acciones</h4>
      <hr />
      <div class="list-group">
        <button type="button" class="list-group-item list-group-item-action" [class.active]="activeView === 'reimprimir'" (click)="setView('reimprimir')">
          <i class="feather icon-printer me-2"></i> Reimprimir
        </button>
        <button type="button" class="list-group-item list-group-item-action" [class.active]="activeView === 'anular'" (click)="setView('anular')">
          <i class="feather icon-slash me-2"></i> Anular
        </button>
        <button type="button" class="list-group-item list-group-item-action" [class.active]="activeView === 'leer'" (click)="setView('leer')">
          <i class="feather icon-eye me-2"></i> Leer Etiquetas
        </button>
        <button type="button" class="list-group-item list-group-item-action" [class.active]="activeView === 'validar'" (click)="setView('validar')">
          <i class="feather icon-check-circle me-2"></i> Validar Etiquetas
        </button>
      </div>
    </div>

    <div class="right-panel">
      <div [ngSwitch]="activeView">
        
        <div *ngSwitchCase="'reimprimir'">
          <h3>Reimprimir Etiquetas</h3>
          <p class="text-muted">Escanee las etiquetas. La información se enviará al backend para su registro.</p>
          
          <form [formGroup]="reprintForm" (ngSubmit)="onReimprimirSubmit()">
            <div class="form-group">
              <label>Escanear Serial (*)</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="serialEntry" 
                [placeholder]="cancelForm.get('fastCancel')?.value ? 'Escanee para anular al instante...' : 'Escanee para la lista...'"
                (keydown.enter)="$event.preventDefault()" 
              /></div>

            <div class="form-group" *ngIf="serialsToReprint.length > 0">
              <label>Seriales en cola ({{ serialsToReprint.length }})</label>
              <ul class="list-group validation-list" style="height: 120px;">
                <li *ngFor="let s of serialsToReprint; let i = index" class="list-group-item d-flex justify-content-between">
                  {{ s }}
                  <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeSerial(serialsToReprint, i)"><i class="feather icon-trash-2"></i></button>
                </li>
              </ul>
            </div>

            <div class="row">
              <div class="col-md-7 form-group">
                <label>Responsable de Reimpresión (*)</label>
                <input type="text" class="form-control" formControlName="personReprints" placeholder="Nombre de quien autoriza" />
              </div>
              <div class="col-md-5 form-group d-flex align-items-end">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="retorno" formControlName="ReturnLabelOld">
                  <label class="form-check-label" for="retorno">¿Retornó etiqueta física?</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Motivo (*)</label>
              <input type="text" class="form-control" formControlName="reason" placeholder="Ej: Error de impresión, daño físico" />
            </div>

            <div *ngIf="serverMessage" class="alert mt-2" [ngClass]="'alert-' + serverMessage.type">
              {{ serverMessage.text }}
            </div>

            <div class="button-group d-flex justify-content-end">
              <button type="submit" class="btn btn-primary" [disabled]="reprintForm.invalid || serialsToReprint.length === 0 || isLoading">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Procesar Reimpresión
              </button>
            </div>
          </form>
        </div>

        <div *ngSwitchCase="'anular'">
          <div class="d-flex justify-content-between align-items-center">
            <h3>Anular Etiquetas</h3>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="fastCancel" [formControl]="$any(cancelForm).get('fastCancel')">
              <label class="form-check-label" for="fastCancel"><strong>Anulación Rápida (Auto-envío)</strong></label>
            </div>
          </div>
          
          <p class="text-muted">
            {{ cancelForm.get('fastCancel')?.value 
              ? 'Modo Rápido: Llene los campos de abajo y escanee para procesar al instante.' 
              : 'Modo Manual: Escanee para listar y luego presione el botón Procesar.' }}
          </p>

          <form [formGroup]="cancelForm" (ngSubmit)="onAnularSubmit()">
            
            <div class="form-group">
              <label>Escanear Serial (*)</label>
              <input type="text" class="form-control" formControlName="serialEntry" 
                    [placeholder]="cancelForm.get('fastCancel')?.value ? 'Escanee para anular al instante...' : 'Escanee para agregar a la lista...'" />
            </div>

            <div class="form-group" *ngIf="serialsToCancel.length > 0 && !cancelForm.get('fastCancel')?.value">
              <label>Seriales en cola ({{ serialsToCancel.length }})</label>
              <ul class="list-group validation-list" style="height: 120px;">
                <li *ngFor="let s of serialsToCancel; let i = index" class="list-group-item d-flex justify-content-between align-items-center">
                  {{ s }}
                  <button type="button" class="btn btn-sm btn-link text-danger" (click)="removeSerial(serialsToCancel, i)">
                    <i class="feather icon-trash-2"></i>
                  </button>
                </li>
              </ul>
            </div>

            <div class="row">
              <div class="col-md-7 form-group">
                <label>Responsable de Anulación (*)</label>
                <input type="text" class="form-control" formControlName="personReprints" placeholder="Nombre de quien autoriza" />
              </div>
              <div class="col-md-5 form-group d-flex align-items-end">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="retornoAnular" formControlName="ReturnLabelOld">
                  <label class="form-check-label" for="retornoAnular">¿Retornó etiqueta física?</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Motivo de Anulación (*)</label>
              <input type="text" class="form-control" formControlName="reason" placeholder="Ej: Error de digitación, etiqueta dañada" />
            </div>

            <div *ngIf="serverMessage" class="alert mt-2" [ngClass]="'alert-' + serverMessage.type">
              {{ serverMessage.text }}
            </div>

            <div class="button-group d-flex justify-content-end" *ngIf="!cancelForm.get('fastCancel')?.value">
              <!-- <button type="submit" class="btn btn-danger" [disabled]="cancelForm.invalid || serialsToCancel.length === 0 || isLoading">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                Procesar Anulación
              </button> -->
            </div>
          </form>
        </div>

        </div>
    </div>
  </div>
</div>