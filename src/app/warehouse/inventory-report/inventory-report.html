<div class="report-wrapper">
  
  <header class="inventory-header">
    <div class="title-section">
      <h1>Informe Final de Inventario</h1>
      <p>Reporte consolidado de existencias y novedades</p>
    </div>
    
    <div class="filter-params">
      <div class="date-input-group">
        <label>Fecha Inicio</label>
        <input type="date" [(ngModel)]="dateIni" (ngModelChange)="loadReport()">
      </div>
      <div class="date-input-group">
        <label>Fecha Fin</label>
        <input type="date" [(ngModel)]="dateEnd" (ngModelChange)="loadReport()">
      </div>
    </div>
  </header>

  <section class="stats-grid">
    <div class="stat-card">
      <i class="ti ti-tags stat-icon"></i>
      <div class="stat-content">
        <span class="stat-value">{{ totalRefs | number }}</span>
        <span class="stat-label">Referencias Únicas</span>
      </div>
    </div>
    <div class="stat-card secondary">
      <i class="ti ti-box stat-icon"></i>
      <div class="stat-content">
        <span class="stat-value">{{ totalItems | number }}</span>
        <span class="stat-label">Total Unidades Capturadas</span>
      </div>
    </div>
  </section>

  <div class="action-bar">
    <div class="search-box">
      <i class="ti ti-search"></i>
      <input 
        type="text" 
        placeholder="Buscar por referencia, producto o barcode..."
        [(ngModel)]="searchTerm"
        (input)="applyFilter()">
    </div>
    <button class="btn-excel" (click)="exportToExcel()">
      <i class="ti ti-file-spreadsheet"></i> Descargar Reporte Excel
    </button>
  </div>

  <div class="groups-list">
    @if (isLoading) {
      <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted fw-bold">Procesando información de inventario...</p>
      </div>
    } @else {
      @for (group of filteredGroups; track group.referencia) {
        <div class="group-item" [class.active]="group.isExpanded">
          <div class="group-header" (click)="toggleGroup(group)">
            <div class="main-info">
              <i class="ti ti-chevron-right arrow" [class.rotated]="group.isExpanded"></i>
              <span class="ref-code">{{ group.referencia }}</span>
              <span class="prod-name">{{ group.producto | uppercase }}</span>
            </div>
            <div class="group-badge">
              <span class="count">{{ group.conteoTotal }}</span>
              <span class="label">Items</span>
            </div>
          </div>

          @if (group.isExpanded) {
            <div class="group-detail">
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Barcode</th>
                      <th>Consecutivo</th>
                      <th>Fecha Captura</th>
                      <th>Estado</th>
                      <th>Novedades</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of group.items; track item.barcode) {
                      <tr>
                        <td><code>{{ item.barcode }}</code></td>
                        <td>{{ item.consecutive }}</td>
                        <td>{{ item.fechaCaptura }}</td>
                        <td>
                          <span class="badge" [ngClass]="item.estado === 'Conforme' ? 'bg-success' : 'bg-warning text-dark'">
                            {{ item.estado }}
                          </span>
                        </td>
                        <td>{{ item.novedades || 'Sin novedades' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }
        </div>
      } @empty {
        <div class="text-center p-5 bg-white rounded-3 shadow-sm">
          <i class="ti ti-search-off f-30 text-muted"></i>
          <p class="mt-3 text-muted">No se encontraron resultados para los criterios seleccionados.</p>
        </div>
      }
    }
  </div>
</div>